<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[blog.tkeo.info]]></title>
  <link href="http://blog.tkeo.info/atom.xml" rel="self"/>
  <link href="http://blog.tkeo.info/"/>
  <updated>2017-05-29T23:35:15+09:00</updated>
  <id>http://blog.tkeo.info/</id>
  <author>
    <name><![CDATA[tkeo]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ElastiCacheの空きメモリのアラートを設定した]]></title>
    <link href="http://blog.tkeo.info/blog/2017/05/29/elasticache-memory-alert/"/>
    <updated>2017-05-29T21:44:01+09:00</updated>
    <id>http://blog.tkeo.info/blog/2017/05/29/elasticache-memory-alert</id>
    <content type="html"><![CDATA[<p>メモリの空きが20%切ったらwarning投げるとか、アラートのしきい値を割合で設定したい。
CloudWatchで取れるのは使用しているサイズなので、なんとかして最大値を取得して計算する必要がある。</p>

<p>最大値自体は<a href="http://docs.aws.amazon.com/cli/latest/reference/elasticache/describe-cache-parameters.html">describe-cache-parameters</a>で取れるのでファイルに書き出しておいて、node_exporterのtextfile collectorで読み込ませることにした。</p>

<p>ファイルは下のような感じのスクリプトで生成した。
あらかじめ取得した値を列挙したけど、めったにノード追加しないので都度取得でもよかったかもしれない。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require "aws-sdk-core"
</span><span class='line'>
</span><span class='line'># elasticache.describe_cache_parameters(cache_parameter_group_name: "default.memcached1.4").
</span><span class='line'>#   cache_node_type_specific_parameters.detect {|param| param.parameter_name == "max_cache_memory" }.
</span><span class='line'>#   cache_node_type_specific_values.map {|value| [value.cache_node_type, value.value] }.to_h
</span><span class='line'>
</span><span class='line'>memcached_max_memories = {
</span><span class='line'>  "cache.c1.xlarge"=&gt;"6600",
</span><span class='line'>  "cache.m1.large"=&gt;"7100",
</span><span class='line'>  "cache.m1.medium"=&gt;"3350",
</span><span class='line'>  "cache.m1.small"=&gt;"1300",
</span><span class='line'>  "cache.m1.xlarge"=&gt;"14600",
</span><span class='line'>  "cache.m2.2xlarge"=&gt;"33800",
</span><span class='line'>  "cache.m2.4xlarge"=&gt;"68000",
</span><span class='line'>  "cache.m2.xlarge"=&gt;"16700",
</span><span class='line'>  "cache.m3.2xlarge"=&gt;"28600",
</span><span class='line'>  "cache.m3.large"=&gt;"6200",
</span><span class='line'>  "cache.m3.medium"=&gt;"2850",
</span><span class='line'>  "cache.m3.xlarge"=&gt;"13600",
</span><span class='line'>  "cache.m4.10xlarge"=&gt;"158355",
</span><span class='line'>  "cache.m4.2xlarge"=&gt;"30412",
</span><span class='line'>  "cache.m4.4xlarge"=&gt;"62234",
</span><span class='line'>  "cache.m4.large"=&gt;"6573",
</span><span class='line'>  "cache.m4.xlarge"=&gt;"14618",
</span><span class='line'>  "cache.r3.2xlarge"=&gt;"59600",
</span><span class='line'>  "cache.r3.4xlarge"=&gt;"120600",
</span><span class='line'>  "cache.r3.8xlarge"=&gt;"242600",
</span><span class='line'>  "cache.r3.large"=&gt;"13800",
</span><span class='line'>  "cache.r3.xlarge"=&gt;"29100",
</span><span class='line'>  "cache.t1.micro"=&gt;"213",
</span><span class='line'>  "cache.t2.medium"=&gt;"3301",
</span><span class='line'>  "cache.t2.micro"=&gt;"555",
</span><span class='line'>  "cache.t2.small"=&gt;"1588",
</span><span class='line'>  "dax.r3.2xlarge"=&gt;"59600",
</span><span class='line'>  "dax.r3.4xlarge"=&gt;"120600",
</span><span class='line'>  "dax.r3.8xlarge"=&gt;"242600",
</span><span class='line'>  "dax.r3.large"=&gt;"13800",
</span><span class='line'>  "dax.r3.xlarge"=&gt;"29100"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'># elasticache.describe_cache_parameters(cache_parameter_group_name: "default.redis2.8").
</span><span class='line'>#   cache_node_type_specific_parameters.detect {|param| param.parameter_name == "maxmemory" }.
</span><span class='line'>#   cache_node_type_specific_values.map {|value| [value.cache_node_type, value.value] }.to_h
</span><span class='line'>
</span><span class='line'>redis_max_memories = {
</span><span class='line'>  "cache.c1.xlarge"=&gt;"6501171200",
</span><span class='line'>  "cache.m1.large"=&gt;"7025459200",
</span><span class='line'>  "cache.m1.medium"=&gt;"3093299200",
</span><span class='line'>  "cache.m1.small"=&gt;"943718400",
</span><span class='line'>  "cache.m1.xlarge"=&gt;"14889779200",
</span><span class='line'>  "cache.m2.2xlarge"=&gt;"35022438400",
</span><span class='line'>  "cache.m2.4xlarge"=&gt;"70883737600",
</span><span class='line'>  "cache.m2.xlarge"=&gt;"17091788800",
</span><span class='line'>  "cache.m3.2xlarge"=&gt;"29989273600",
</span><span class='line'>  "cache.m3.large"=&gt;"6501171200",
</span><span class='line'>  "cache.m3.medium"=&gt;"2988441600",
</span><span class='line'>  "cache.m3.xlarge"=&gt;"14260633600",
</span><span class='line'>  "cache.m4.10xlarge"=&gt;"166047614239",
</span><span class='line'>  "cache.m4.2xlarge"=&gt;"31889126359",
</span><span class='line'>  "cache.m4.4xlarge"=&gt;"65257290629",
</span><span class='line'>  "cache.m4.large"=&gt;"6892593152",
</span><span class='line'>  "cache.m4.xlarge"=&gt;"15328501760",
</span><span class='line'>  "cache.r3.2xlarge"=&gt;"62495129600",
</span><span class='line'>  "cache.r3.4xlarge"=&gt;"126458265600",
</span><span class='line'>  "cache.r3.8xlarge"=&gt;"254384537600",
</span><span class='line'>  "cache.r3.large"=&gt;"14470348800",
</span><span class='line'>  "cache.r3.xlarge"=&gt;"30513561600",
</span><span class='line'>  "cache.t1.micro"=&gt;"142606336",
</span><span class='line'>  "cache.t2.medium"=&gt;"3461349376",
</span><span class='line'>  "cache.t2.micro"=&gt;"581959680",
</span><span class='line'>  "cache.t2.small"=&gt;"1665138688",
</span><span class='line'>  "dax.r3.2xlarge"=&gt;"62495129600",
</span><span class='line'>  "dax.r3.4xlarge"=&gt;"126458265600",
</span><span class='line'>  "dax.r3.8xlarge"=&gt;"254384537600",
</span><span class='line'>  "dax.r3.large"=&gt;"14470348800",
</span><span class='line'>  "dax.r3.xlarge"=&gt;"30513561600"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>elasticache = Aws::ElastiCache::Client.new(region: "ap-northeast-1")
</span><span class='line'>cache_clusters = elasticache.describe_cache_clusters(show_cache_node_info: true).cache_clusters
</span><span class='line'>cache_clusters.each do |cluster|
</span><span class='line'>  if cluster.engine == "memcached"
</span><span class='line'>    max_memory = memcached_max_memories[cluster.cache_node_type].to_i * 1024**2
</span><span class='line'>  else
</span><span class='line'>    max_memory = redis_max_memories[cluster.cache_node_type].to_i
</span><span class='line'>  end
</span><span class='line'>  cluster.cache_nodes.each do |node|
</span><span class='line'>    puts %(aws_elasticache_max_memory_bytes{cache_cluster_id="#{cluster.cache_cluster_id}",cache_node_id="#{node.cache_node_id}"} #{max_memory})
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>出力はこんな感じ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aws_elasticache_max_memory_bytes{cache_cluster_id="memcache-example",cache_node_id="0001"} 581959680</span></code></pre></td></tr></table></div></figure>


<p>これをnode_exporter経由で取得した値と、cloudwatch_exporterで取得した値ではラベルが違うので、<code>metric_relabel_configs</code>を使って同じになるように調整する必要がある。
exporter側でjobとinstanceを設定してもprometheusで読み込むときにprefixを付けてリネームしてしまうのでこうせざるを得なかった。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># prometheus.yml
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'prometheus'
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9100']
</span><span class='line'>    metric_relabel_configs:
</span><span class='line'>      - source_labels: [__name__]
</span><span class='line'>        regex: aws.*
</span><span class='line'>        target_label: job
</span><span class='line'>        replacement: cloudwatch
</span><span class='line'>      - source_labels: [cache_cluster_id, cache_node_id]
</span><span class='line'>        regex: (.+);(.+)
</span><span class='line'>        target_label: instance
</span><span class='line'>        replacement: cache.${1}.${2}
</span><span class='line'>  - job_name: 'cloudwatch'
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9106']
</span><span class='line'>    metric_relabel_configs:
</span><span class='line'>      - source_labels: [cache_cluster_id, cache_node_id]
</span><span class='line'>        regex: (.+);(.+)
</span><span class='line'>        target_label: instance
</span><span class='line'>        replacement: cache.${1}.${2}
</span><span class='line'>      - action: labeldrop
</span><span class='line'>        regex: exported_job</span></code></pre></td></tr></table></div></figure>


<p>あとはアラートのruleを設定するだけ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ALERT elasticache_memcached_used_memory
</span><span class='line'>  IF aws_elasticache_bytes_used_for_cache_items_average / aws_elasticache_max_memory_bytes &gt; 0.8
</span><span class='line'>  LABELS { severity = "warning" }
</span><span class='line'>  ANNOTATIONS {
</span><span class='line'>    summary = "Used memory is large",
</span><span class='line'>    description = "(): B"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>ALERT elasticache_redis_used_memory
</span><span class='line'>  IF aws_elasticache_bytes_used_for_cache_average / aws_elasticache_max_memory_bytes &gt; 0.5
</span><span class='line'>  LABELS { severity = "warning" }
</span><span class='line'>  ANNOTATIONS {
</span><span class='line'>    summary = "Used memory is large",
</span><span class='line'>    description = "(): B"
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>はじめはredis,memcached共通で使える<code>aws_elasticache_freeable_memory_average</code>を使って設定したら1.4とかふざけた値になったので、使用量を元に計算するように変更した。
これって自分の環境だけなのかな…</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[prometheus, blackbox_exporter, komachi_heartbeat]]></title>
    <link href="http://blog.tkeo.info/blog/2017/05/12/prometheus-blackbox-exporter/"/>
    <updated>2017-05-12T22:00:33+09:00</updated>
    <id>http://blog.tkeo.info/blog/2017/05/12/prometheus-blackbox-exporter</id>
    <content type="html"><![CDATA[<p>最近<a href="https://prometheus.io/">Prometheus</a>の導入に向けて検証中。
今日は外形監視の設定を試した。</p>

<p>外形監視には<a href="https://github.com/prometheus/blackbox_exporter">blackbox_exporter</a>を使う。
<a href="https://github.com/mitaku/komachi_heartbeat">komachi_heartbeat</a>を導入しているので、レスポンスとして<code>heartbeat:ok</code>が返ってくるかチェックできればよい。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># prometheus.yml
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'blackbox'
</span><span class='line'>    metrics_path: /probe
</span><span class='line'>    params:
</span><span class='line'>      module: [http_komachi_heartbeat]
</span><span class='line'>      path: ['/path/to/heartbeat']
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets:
</span><span class='line'>        - example.com
</span><span class='line'>    relabel_configs:
</span><span class='line'>      - source_labels: [__address__, __param_path]
</span><span class='line'>        regex: (.*);(.*)
</span><span class='line'>        target_label: __param_target
</span><span class='line'>        replacement: http://${1}${2}
</span><span class='line'>      - source_labels: []
</span><span class='line'>        regex: .*
</span><span class='line'>        target_label: __address__
</span><span class='line'>        replacement: 127.0.0.1:9115  # blackbox_exporterが動いているIPアドレスにする</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># blackbox.yml
</span><span class='line'>modules:
</span><span class='line'>  http_komachi_heartbeat:
</span><span class='line'>    prober: http
</span><span class='line'>    timeout: 5s
</span><span class='line'>    http:
</span><span class='line'>      fail_if_not_matches_regexp:
</span><span class='line'>      - "heartbeat:ok"</span></code></pre></td></tr></table></div></figure>


<p>複数あるwebサーバーそれぞれに対してリクエストを投げるのは以下のような感じ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># prometheus.yml
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'blackbox'
</span><span class='line'>    metrics_path: /probe
</span><span class='line'>    params:
</span><span class='line'>      module: [http_komachi_heartbeat]
</span><span class='line'>      path: ['/path/to/heartbeat']
</span><span class='line'>    ec2_sd_configs:
</span><span class='line'>      - region: ap-northeast-1
</span><span class='line'>        port: 9100
</span><span class='line'>    relabel_configs:
</span><span class='line'>      - source_labels: [__meta_ec2_tag_role]
</span><span class='line'>        regex: web
</span><span class='line'>        action: keep
</span><span class='line'>      - source_labels: [__meta_ec2_tag_Name]
</span><span class='line'>        regex: (.*)
</span><span class='line'>        target_label: name
</span><span class='line'>        replacement: ${1}
</span><span class='line'>      - source_labels: [__param_target]
</span><span class='line'>        regex: (.*)
</span><span class='line'>        target_label: instance
</span><span class='line'>        replacement: ${1}
</span><span class='line'>      - source_labels: [__meta_ec2_public_ip, __param_path]
</span><span class='line'>        regex: (.*);(.*)
</span><span class='line'>        target_label: __param_target
</span><span class='line'>        replacement: http://${1}${2}
</span><span class='line'>      - source_labels: []
</span><span class='line'>        regex: .*
</span><span class='line'>        target_label: __address__
</span><span class='line'>        replacement: 127.0.0.1:9115  # blackbox_exporterが動いているIPアドレスにする</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># blackbox.yml
</span><span class='line'>modules:
</span><span class='line'>  http_komachi_heartbeat:
</span><span class='line'>    prober: http
</span><span class='line'>    timeout: 5s
</span><span class='line'>    http:
</span><span class='line'>      headers:
</span><span class='line'>        Host: example.com
</span><span class='line'>      fail_if_not_matches_regexp:
</span><span class='line'>      - "heartbeat:ok"</span></code></pre></td></tr></table></div></figure>


<p>監視したいドメインが複数ある場合、ドメインごとにblackbox.ymlの設定を増やしていかないといけないのが微妙かもしれない。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rubyのrefinementsを使ってみたかった]]></title>
    <link href="http://blog.tkeo.info/blog/2017/03/20/refinements/"/>
    <updated>2017-03-20T22:48:28+09:00</updated>
    <id>http://blog.tkeo.info/blog/2017/03/20/refinements</id>
    <content type="html"><![CDATA[<p>今やってるプロジェクトでrefinementsを使うのが適していそうな場面が出てきたので初めて使ってみることにしたがなんだか微妙な感じになったという日記。</p>

<p>試したバージョンは2.3.3と2.4.0で、このあたりを参考にした。</p>

<ul>
<li><a href="https://docs.ruby-lang.org/en/trunk/syntax/refinements_rdoc.html">https://docs.ruby-lang.org/en/trunk/syntax/refinements_rdoc.html</a></li>
<li><a href="http://qiita.com/joker1007/items/68d066a12bc763bd2cb4">http://qiita.com/joker1007/items/68d066a12bc763bd2cb4</a></li>
</ul>


<p>同じmoduleをincludeしているクラスに対して共通のrefinementsを適用したかったが、2.3ではmoduleに対してrefineは使えないのでrefineブロック内でincludeしてみたが…</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module C
</span><span class='line'>end
</span><span class='line'>class A
</span><span class='line'>  include C
</span><span class='line'>end
</span><span class='line'>class B
</span><span class='line'>  include C
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>module Foo
</span><span class='line'>  def foo
</span><span class='line'>    "foo"
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def foobar
</span><span class='line'>    foo + "bar"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>module R
</span><span class='line'>  refine A do
</span><span class='line'>    include Foo
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  refine B do
</span><span class='line'>    include Foo
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>using R
</span><span class='line'>puts A.new.foo    # =&gt; foo
</span><span class='line'>puts B.new.foo    # =&gt; foo
</span><span class='line'>puts A.new.foobar # =&gt; undefined local variable or method `foo' for #&lt;A:0x007fc71782dcb0&gt; (NameError)</span></code></pre></td></tr></table></div></figure>


<p>どうもそう単純にはいかないらしい。ぐぬぬ。</p>

<p>いろいろこねくり回した結果、思った通りの動きをするコードは一応何通りか書けた。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module C
</span><span class='line'>end
</span><span class='line'>class A
</span><span class='line'>  include C
</span><span class='line'>end
</span><span class='line'>class B
</span><span class='line'>  include C
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'># module_evalで無理やり突っ込むパターン
</span><span class='line'>FooMethods = -&gt; {
</span><span class='line'>  def foo
</span><span class='line'>    "foo"
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def foobar
</span><span class='line'>    foo + "bar"
</span><span class='line'>  end
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>module R
</span><span class='line'>  refine A do
</span><span class='line'>    module_eval do
</span><span class='line'>      FooMethods.call
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  refine B do
</span><span class='line'>    module_eval do
</span><span class='line'>      FooMethods.call
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'># module_eval内でrefineしちゃうパターン
</span><span class='line'>module R2
</span><span class='line'>  %w(A B).each do |klass|
</span><span class='line'>    module_eval &lt;&lt;-CODE
</span><span class='line'>      refine #{klass} do
</span><span class='line'>        def foo
</span><span class='line'>          "foo"
</span><span class='line'>        end
</span><span class='line'>
</span><span class='line'>        def foobar
</span><span class='line'>          foo + "bar"
</span><span class='line'>        end
</span><span class='line'>      end
</span><span class='line'>    CODE
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'># あきらめたパターン
</span><span class='line'>module R3
</span><span class='line'>  refine Object do
</span><span class='line'>    def foo
</span><span class='line'>      if kind_of?(C)
</span><span class='line'>        "foo"
</span><span class='line'>      else
</span><span class='line'>        raise NoMethodError
</span><span class='line'>      end
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    def foobar
</span><span class='line'>      if kind_of?(C)
</span><span class='line'>        foo + "bar"
</span><span class='line'>      else
</span><span class='line'>        raise NoMethodError
</span><span class='line'>      end
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>using R
</span><span class='line'>puts A.new.foo    # =&gt; foo
</span><span class='line'>puts B.new.foo    # =&gt; foo
</span><span class='line'>puts A.new.foobar # =&gt; foobar</span></code></pre></td></tr></table></div></figure>


<p>うーん…どれもなんかやだな。
もうちょっとうまいやり方はないものか。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rdbtoolsを使ってredisのデータの内訳を調べた]]></title>
    <link href="http://blog.tkeo.info/blog/2017/03/08/using-rdbtools/"/>
    <updated>2017-03-08T01:06:23+09:00</updated>
    <id>http://blog.tkeo.info/blog/2017/03/08/using-rdbtools</id>
    <content type="html"><![CDATA[<p>最近redisのデータ量が増えすぎて、スワップを使い始めている状態になってしまった。
メモリ使用量は7.3GBでキーの数は1400万ぐらい。
スケールアップを検討しつつも、余計なデータがないか軽く調査。
以前にもやったことがあるけど忘れるので後のためにメモとして残しておく。</p>

<p>まずrdbファイルを取得する。<a href="http://docs.aws.amazon.com/ja_jp/AmazonElastiCache/latest/UserGuide/Snapshots.Exporting.html">バックアップのエクスポート</a>で今日のバックアップをS3にエクスポートした。1.8GBぐらい。</p>

<p>ファイルがでかいのでAWS上で作業する。
本番ウェブサーバーのコピーを使って適当に立てたインスタンスに<a href="https://github.com/sripathikrishnan/redis-rdb-tools">rdbtools</a>をインストール。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pip install rdbtools
</span><span class='line'>Downloading/unpacking rdbtools
</span><span class='line'>  Downloading rdbtools-0.1.9.tar.gz
</span><span class='line'>  Running setup.py (path:/tmp/pip_build_root/rdbtools/setup.py) egg_info for package rdbtools
</span><span class='line'>    warning: no files found matching 'README.textile'
</span><span class='line'>Downloading/unpacking redis (from rdbtools)
</span><span class='line'>  Downloading redis-2.10.5-py2.py3-none-any.whl (60kB): 60kB downloaded
</span><span class='line'>Installing collected packages: rdbtools, redis
</span><span class='line'>  Running setup.py install for rdbtools
</span><span class='line'>    warning: no files found matching 'README.textile'
</span><span class='line'>    Installing redis-memory-for-key script to /usr/bin
</span><span class='line'>    Installing redis-profiler script to /usr/bin
</span><span class='line'>    Installing rdb script to /usr/bin
</span><span class='line'>Successfully installed rdbtools redis
</span><span class='line'>Cleaning up…</span></code></pre></td></tr></table></div></figure>


<p>これでOKなはずだったが・・・</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rdb -c memory dump-2017-03-06-0001.rdb -f redis-memory-2017-03-06.csv
</span><span class='line'>Traceback (most recent call last):
</span><span class='line'>  File "/usr/bin/rdb", line 5, in &lt;module&gt;
</span><span class='line'>    from pkg_resources import load_entry_point
</span><span class='line'>  File "/usr/lib/python2.6/site-packages/pkg_resources.py", line 2655, in &lt;module&gt;
</span><span class='line'>    working_set.require(__requires__)
</span><span class='line'>  File "/usr/lib/python2.6/site-packages/pkg_resources.py", line 648, in require
</span><span class='line'>    needed = self.resolve(parse_requirements(requirements))
</span><span class='line'>  File "/usr/lib/python2.6/site-packages/pkg_resources.py", line 546, in resolve
</span><span class='line'>    raise DistributionNotFound(req)
</span><span class='line'>pkg_resources.DistributionNotFound: redis</span></code></pre></td></tr></table></div></figure>


<p>あれ？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip list | grep redis
</span><span class='line'>redis (2.10.5)</span></code></pre></td></tr></table></div></figure>


<p>？？</p>

<p>以前やったときはこんなことにはならなかったが？？？</p>

<p>よく見るとどうやら最新は9日前にリリースされたバージョンで、前回使ったのは古いやつだったらしい。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pip uninstall rdbtools
</span><span class='line'>$ sudo pip install rdbtools==0.1.8</span></code></pre></td></tr></table></div></figure>


<p>これでとりあえず動いた。pythonのバージョンの問題な気がするが、よくわからんので放置。</p>

<p>CSVの生成には20分ぐらいかかった。
次は出力されたCSVを加工していく。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>database,type,key,size_in_bytes,encoding,num_elements,len_largest_element
</span><span class='line'>0,string,"user:6665644:ip_address",104,string,13,13
</span><span class='line'>0,string,"user:5568100:logged_in_time",96,string,8,8
</span><span class='line'>0,string,"user:7540191:ip_address",104,string,13,13
</span><span class='line'>0,string,"user:3428265:ip_address",104,string,12,12
</span><span class='line'>0,string,"user:2176673:logged_in_time",96,string,8,8
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>出力されたCSVの中身はこんな感じ。
redis-objects gem使ってるとこういうキーのやつがいっぱいできちゃうよなー。
まとめやすいようにidっぽい部分を雑に置換する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat redis-memory-2017-03-06.csv | ruby -ne '_,_,key,size = $_.split(","); puts [key.gsub(/:\d+/, ":*"), size].join(",")' &gt; tmp.csv</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>key,size_in_bytes
</span><span class='line'>"user:*:ip_address",104
</span><span class='line'>"user:*:logged_in_time",96
</span><span class='line'>"user:*:ip_address",104
</span><span class='line'>"user:*:ip_address",104
</span><span class='line'>"user:*:logged_in_time",96
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>こいつを合計するスクリプトをざっと書いた。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat redis-summary.rb
</span><span class='line'>#!/usr/bin/env ruby
</span><span class='line'>
</span><span class='line'>count = Hash.new {|h,k| h[k] = 0 }
</span><span class='line'>sum = Hash.new {|h,k| h[k] = 0 }
</span><span class='line'>
</span><span class='line'>while line = $stdin.gets
</span><span class='line'>  key,size = line.split(",")
</span><span class='line'>  count[key] += 1
</span><span class='line'>  sum[key] += size.to_i
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>count.keys.each do |key|
</span><span class='line'>  puts [key, count[key], sum[key]].join(",")
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"user:*:ip_address",5537264,583765440
</span><span class='line'>"user:*:logged_in_time",5538922,531736432
</span><span class='line'>"room:*:ready_members",25817,3654184
</span><span class='line'>"user_deck:*:total_power_cache",548302,57306072
</span><span class='line'>"room:*:status_value",175756,19190496
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>余計なものがたくさんありそうなことはわかったけど、こいつらを消してもまだ足りなさそうな気がするなあ。</p>

<h2>追記</h2>

<p>定期的に削除する/できるようにする前のデータが残っていたのでまとめて削除した。
実装に手を入れたタイミングで消したつもりだった…。</p>

<p><img src="http://blog.tkeo.info/images/screenshot-2017-03-10.png" alt="graph" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Octopressデプロイ環境を作り直した]]></title>
    <link href="http://blog.tkeo.info/blog/2017/02/02/octopress-setup-again/"/>
    <updated>2017-02-02T21:44:43+09:00</updated>
    <id>http://blog.tkeo.info/blog/2017/02/02/octopress-setup-again</id>
    <content type="html"><![CDATA[<p>雑なメモ。
会社からでも更新できるように環境を作った。</p>

<p>とりあえずcloneしてsourceブランチに切り替える。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git@github.com:tkeo/tkeo.github.io.git blog
</span><span class='line'>cd blog
</span><span class='line'>git co -t origin/source</span></code></pre></td></tr></table></div></figure>


<p>もろもろ必要なgemをinstallする。bundle execとか付けたくないので雑にgemsetに突っ込む。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rbenv gemset init blog
</span><span class='line'>bundle</span></code></pre></td></tr></table></div></figure>


<p>デプロイするには_deployディレクトリにmasterブランチが必要なのでworktreeを作る。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git worktree add _deploy master</span></code></pre></td></tr></table></div></figure>


<p>これでOK。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[fish shellに移行した]]></title>
    <link href="http://blog.tkeo.info/blog/2017/01/31/switch-to-fish-shell/"/>
    <updated>2017-01-31T00:15:30+09:00</updated>
    <id>http://blog.tkeo.info/blog/2017/01/31/switch-to-fish-shell</id>
    <content type="html"><![CDATA[<p>学生の頃にzshを使い始めてかれこれ10年以上になるが、2ヶ月ほど前にfishに移行した。
ようやく慣れてきたのでメモを残しておく。</p>

<p>使用しているfishのバージョンは2.4.0で、プラグインなどは入れてない。
<a href="https://github.com/oh-my-fish/oh-my-fish">oh-my-fish</a>を使うと便利っぽいけど、困ったときに入れたらいいかなと思ってまだ困ってないので使ってない。</p>

<h2>config</h2>

<p>とりあえず<code>~/.zshrc</code>をベースに<code>~/.config/fish/config.fish</code>を作った。
<code>alias</code>とか<code>export</code>とかは大体そのままコピペで動くが、なぜかPATHのexportだけはうまくいかなかったので<code>set</code>を使うように変更した。</p>

<p>他は<code>if</code>を<code>end</code>で閉じるとか、<code>&amp;&amp;</code>のかわりに<code>; and</code>を使うとか、<code>$( )</code>は<code>( )</code>にするとか、気をつけないといけないポイントはいくつかあるけどそのへんは適当に。</p>

<h2>補完</h2>

<p>サーバーにログインするときはsshrcを使っていて、sshコマンドと同じようにタブでホスト名を補完してほしい。そういうときの設定は以下。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>complete -c sshrc -w ssh</span></code></pre></td></tr></table></div></figure>


<p><a href="https://fishshell.com/docs/current/commands.html#complete">complete - edit command specific tab-completions</a></p>

<h2>一時的な環境変数</h2>

<p>例えばzshの場合だとこんな感じのコマンドを実行することがあるけど</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RAILS_ENV=test rake db:reset</span></code></pre></td></tr></table></div></figure>


<p>fishだとこれではダメで、<code>env</code>をつける必要がある。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>env RAILS_ENV=test rake db:reset</span></code></pre></td></tr></table></div></figure>


<p><a href="https://fishshell.com/docs/current/faq.html#faq-single-env">How do I set an environment variable for just one command?</a></p>

<h2>ブレース展開</h2>

<p><code>{ }</code>の中身が展開されるため、展開を抑制したいときはエスケープが必要。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git stash drop stash@\{1\}</span></code></pre></td></tr></table></div></figure>


<p>とか、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g model foo bar:references\{polymorphic\}</span></code></pre></td></tr></table></div></figure>


<p>とか。ちょっと面倒。gitの引数の場合はタブ補完でバックスラッシュをちゃんとつけてくれる。</p>

<h2>プロセス置換</h2>

<p>コマンド実行結果をファイルのように扱うやつ。zshだとこんな感じ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>diff &lt;(foo) &lt;(bar)</span></code></pre></td></tr></table></div></figure>


<p>fishの場合は<code>psub</code>を使う。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>diff (foo | psub) (bar | psub)</span></code></pre></td></tr></table></div></figure>


<p><a href="https://fishshell.com/docs/current/commands.html#psub">psub - perform process substitution</a></p>

<h2>履歴</h2>

<p>zshのshare_history相当のものが無いため最初は戸惑ったが、普段使っているコマンドのパターンはそれほど多くなかったので履歴が育てば不要だった。</p>

<p>それでもtmuxの別のwindow/paneで少し前に打ったコマンドがほしくなることはたまにあって、そういうときは<code>history merge</code>を実行して履歴を再読込している。</p>

<p>自動でmergeするのを試してみたけどコマンド実行のたびに微妙に待たされてストレスたまるので手動運用のほうがよいと思う。</p>

<p><a href="https://fishshell.com/docs/current/commands.html#history">history - Show and manipulate command history</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UTF-16なファイルのgit diffを見たい]]></title>
    <link href="http://blog.tkeo.info/blog/2015/02/26/git-diff-utf-16/"/>
    <updated>2015-02-26T22:36:45+09:00</updated>
    <id>http://blog.tkeo.info/blog/2015/02/26/git-diff-utf-16</id>
    <content type="html"><![CDATA[<p>gitがUTF-16のファイルをバイナリだと認識してしまって、diffが表示されずに困ったので以下の設定をした。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git config diff.toutf8.textconv 'nkf -w8'</span></code></pre></td></tr></table></div></figure>


<p>.gitattributesファイルに以下の一行を書く。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>*.cs diff=toutf8</span></code></pre></td></tr></table></div></figure>


<p>これでcsファイルをUTF-8に変換してからdiffを取るようになった。</p>

<p>ググるとiconvを使うのが見つかるけど、UnityアセットのソースコードがUTF-8のものとUTF-16のものが混在しているので、入力をよしなに判別してくれるnkfを使うようにした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[社内LT大会で家電ChatOpsについて話した]]></title>
    <link href="http://blog.tkeo.info/blog/2014/12/22/kaden-chatops/"/>
    <updated>2014-12-22T00:59:45+09:00</updated>
    <id>http://blog.tkeo.info/blog/2014/12/22/kaden-chatops</id>
    <content type="html"><![CDATA[<script async class="speakerdeck-embed" data-id="d461abf06b5401323dd202d7d619be38" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>


<p>IRKitを使って、ChatOpsやってみたよっていう話を先週の社内LT大会で話しました。
ChatOpsしたい、rubotyとhubot使いたいっていうのが目的なので、わざとまわりくどいことをやってます。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[EmacsでUnity開発をする]]></title>
    <link href="http://blog.tkeo.info/blog/2014/12/10/unity-with-emacs/"/>
    <updated>2014-12-10T06:00:00+09:00</updated>
    <id>http://blog.tkeo.info/blog/2014/12/10/unity-with-emacs</id>
    <content type="html"><![CDATA[<p>これは<a href="http://www.adventar.org/calendars/518">ドリコム Advent Calendar 2014</a>の10日目の記事です。</p>

<p>9日目は<a href="https://twitter.com/y05_net">@hiracy</a>さんによる<a href="http://qiita.com/y05_net/items/c8bfb69ff624d4b711e4">サーバが増えた時にインフラ担当者がやってきたこと</a>です。</p>

<h2>自己紹介</h2>

<ul>
<li><a href="https://twitter.com/tkeo">@tkeo</a></li>
<li>2007年新卒でドリコムに入社、8年目</li>
<li>メインの仕事はスマホゲームのサーバサイド(Rails)で、今年からクライアント(Unity)のほうも触り始めた</li>
<li>Rails歴 6年、Unity歴 8ヶ月</li>
<li>いまの作業比率は サーバ:クライアント = 2:1 ぐらい</li>
</ul>


<h2>今回の話</h2>

<p>Unityを始めた当初はMonoDevelopを使っていたのですが、どうにも手になじまず腹が立ったので、普段サーバ側の開発で使っているemacsを使うことにしました。</p>

<p>以下はいろいろハマりながらも、インターネット上の先人の力を借りてまとめた自分の設定です。</p>

<h2>環境</h2>

<ul>
<li>Mac OS X Mavericks</li>
<li>emacs 24.4.1</li>
<li>パッケージ管理はcask</li>
</ul>


<h2><a href="https://github.com/josteink/csharp-mode">csharp-mode</a></h2>

<p>これがなくては始まらないC#用のメジャーモード。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="c1">; cask</span>
</span><span class='line'><span class="p">(</span><span class="nv">depends-on</span> <span class="s">&quot;csharp-mode&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="c1">; init.el</span>
</span><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;csharp-mode</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;csharp-mode-hook</span>
</span><span class='line'>          <span class="o">&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
</span><span class='line'>             <span class="p">(</span><span class="k">setq</span> <span class="nv">indent-tabs-mode</span> <span class="no">nil</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="k">setq</span> <span class="nv">c-basic-offset</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="nv">c-set-offset</span> <span class="ss">&#39;substatement-open</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="nv">flycheck-mode</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="nv">omnisharp-mode</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>自動補完</h2>

<h3><a href="https://github.com/OmniSharp/omnisharp-server">OmniSharpServer</a></h3>

<p>C#のコードをパースしたりいろいろやってくれる（らしい）サーバです。
他のエディタでも使えるらしいです。</p>

<p>monoが必要なのでインストールして、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ brew install mono
</span></code></pre></td></tr></table></div></figure>


<p>あとはREADME通りにビルド。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ git clone https://github.com/nosami/OmniSharpServer.git
</span><span class='line'>$ cd OmniSharpServer
</span><span class='line'>$ git submodule update --init --recursive
</span><span class='line'>$ xbuild
</span></code></pre></td></tr></table></div></figure>


<p>すると<code>OmniSharp/bin/Debug</code>に<code>OmniSharp.exe</code>ができているはず。
試しに起動してみる。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ mono OmniSharp/bin/Debug/OmniSharp.exe -s /path/to/unity-project.sln
</span></code></pre></td></tr></table></div></figure>


<p>するとずらずらっとLoadingほげほげと出てきて、<code>Solution has finished loading</code>で起動完了。無事起動が確認できたらCtrl+Cで止めておく（このあとemacsから起動するので）</p>

<h3><a href="https://github.com/OmniSharp/omnisharp-emacs">omnisharp-emacs</a></h3>

<p>OmniSharpServerをemacsから使うためのものです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="c1">; cask</span>
</span><span class='line'><span class="p">(</span><span class="nv">depends-on</span> <span class="s">&quot;omnisharp&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="c1">; init.el</span>
</span><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;omnisharp</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">setq</span> <span class="nv">omnisharp-server-executable-path</span> <span class="p">(</span><span class="nv">expand-file-name</span> <span class="s">&quot;/path/to/OmniSharp/bin/Debug/OmniSharp.exe&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>csファイルを開いた時にslnファイルを選べと言われるので、選んであげるとバックグラウンドで起動してくれます。</p>

<p><code>M-x omnisharp-auto-complete</code>で候補表示、<code>M-x omnisharp-go-to-definition</code>で定義にジャンプできます。
適当なキーバインドを設定しておくと便利。</p>

<h2>文法チェック</h2>

<p><a href="http://www.flycheck.org/en/latest/">flycheck</a></p>

<p>omnisharp-emacsにcheckerが含まれていて、OmniSharpサーバと連携してチェックをしてくれます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="c1">; cask</span>
</span><span class='line'><span class="p">(</span><span class="nv">depends-on</span> <span class="s">&quot;flycheck&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="c1">; init.el</span>
</span><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;flycheck</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">setq</span> <span class="nv">flycheck-check-syntax-automatically</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">mode-enabled</span> <span class="nv">save</span> <span class="nv">idle-change</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">setq</span> <span class="nv">flycheck-idle-change-delay</span> <span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>emacsclientアプリ化</h2>

<p>Unity上でcsファイルをダブルクリックして開きたくなったときのための設定（あまりしないけど）</p>

<p>Unityの設定で外部エディタに指定できるのはMacのアプリ(*.app)だけなので、emacsclientを起動するアプリを作ります。
<a href="https://gist.github.com/mkitt/824401">vim用にやっている人がいた</a>のでその設定を参考にしました。</p>

<p>アプリを作るのにはAutomatorを使います。手順は以下のとおり。</p>

<ol>
<li>アプリケーションを選択。</li>
<li>アクション＞ユーティリティの中にある「AppleScriptを実行」を右にドラッグ＆ドロップ。</li>
<li>下記コードを貼り付けて、appを適当な場所に保存。</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='applescript'><span class='line'><span class="k">on</span> <span class="nb">run</span> <span class="p">{</span><span class="nv">input</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">}</span>
</span><span class='line'>    <span class="nb">do shell script</span> <span class="s2">&quot;/usr/local/bin/emacsclient -n &quot;</span> <span class="o">&amp;</span> <span class="nb">quoted form</span> <span class="k">of</span> <span class="nv">POSIX</span> <span class="na">path</span> <span class="k">of</span> <span class="nv">input</span>
</span><span class='line'><span class="k">end</span> <span class="nb">run</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://blog.tkeo.info/images/screenshot-2014-12-10-automator.png" alt="automator" /></p>

<p>作ったappをUnity上で指定してあげると、外部エディタとしてemacsが使えるようになります。
あとはserverとして起動するのを忘れずに。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="c1">; init.el</span>
</span><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;server</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">server-running-p</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">server-start</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>リファレンス検索</h2>

<p>rubyの開発でも使っている<a href="http://kapeli.com/dash">Dash</a>を使えるようにします。</p>

<h3>dash-at-point</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nv">depends-on</span> <span class="s">&quot;dash-at-point&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="c1">; init.el</span>
</span><span class='line'><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c d&quot;</span><span class="p">)</span> <span class="ss">&#39;dash-at-point</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-c e&quot;</span><span class="p">)</span> <span class="ss">&#39;dash-at-point-with-docset</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;dash-at-point-mode-alist</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">csharp-mode</span> <span class="o">.</span> <span class="s">&quot;cs&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>カーソル位置の単語で検索します。
上記設定ではcsharp-modeのときはキーワード &ldquo;cs&rdquo; が設定されたdocsetの中から検索します。</p>

<p><img src="http://blog.tkeo.info/images/screenshot-2014-12-10-dash.png" alt="dash" /></p>

<p>Dash側で画像のようにキーワードを設定しておくと、.NET FrameworkとUnity 3Dのドキュメントを同時に検索できます。</p>

<h3>自前docsetを作る</h3>

<p>doxygenを使えばDash用のdocsetを作れます。
コードを含むアセットを購入した時に（たまに）やってます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ brew install doxygen
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ cat doxygen.config
</span><span class='line'>GENERATE_DOCSET        = YES
</span><span class='line'>SEARCHENGINE           = NO
</span><span class='line'>DISABLE_INDEX          = YES
</span><span class='line'>GENERATE_TREEVIEW      = NO
</span><span class='line'>GENERATE_LATEX         = NO
</span><span class='line'>GENERATE_HTMLHELP      = YES
</span><span class='line'>RECURSIVE              = YES
</span><span class='line'>
</span><span class='line'>PROJECT_NAME           = hogehoge
</span><span class='line'>OUTPUT_DIRECTORY       = output
</span><span class='line'>INPUT                  = path/to/Scripts
</span><span class='line'>DOCSET_BUNDLE_ID       = hogehoge
</span></code></pre></td></tr></table></div></figure>


<p>こんな感じの設定ファイルを作って、まずはHTMLドキュメントを生成。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ doxygen doxygen.config
</span></code></pre></td></tr></table></div></figure>


<p>htmlディレクトリに移動してmakeをたたくとdocsetが作られます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>$ cd output/html
</span><span class='line'>$ make
</span><span class='line'>$ open hogehoge.docset
</span></code></pre></td></tr></table></div></figure>


<h2>その他</h2>

<p>日本語を含むときはBOM付きで保存しないと化けます。<code>C-x RET f</code>で<code>utf-8-with-signature</code>に変更。</p>

<h2>まとめ</h2>

<p>以上、MonoDevelopを使わずにemacsでUnity開発するための設定を紹介しました。</p>

<p>明日はみっきーさんです。</p>

<h2>参考リンク</h2>

<ul>
<li><a href="http://qiita.com/fujimisakari/items/d043a2fae31ed740e290">EmacsでUnity開発(c#)するための環境構築 - Qiita</a></li>
<li><a href="http://bocchies.hatenablog.com/entry/2014/05/09/041130">Emacs24.3(for Mac OSX)でUnity用のC#を書くために - とあるぼっちの生存報告</a></li>
<li><a href="http://decomo.info/wiki/emacs/emacs_24.3_csharp_code_completion_with_omnisharp">Emacs 24.3 + omnisharp-emacsで快適C#生活 [クソゲ〜製作所]</a></li>
<li><a href="https://gist.github.com/mkitt/824401">AppleScript for use with Automator which allows opening files within Terminal Vim</a></li>
<li><a href="http://d.hatena.ne.jp/nakamura001/20121208/1354985761">NGUI のプログラムを元にオフラインでも使えるAPIリファレンスを作る方法 - 強火で進め</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ブログ引っ越し]]></title>
    <link href="http://blog.tkeo.info/blog/2014/12/09/moved/"/>
    <updated>2014-12-09T02:38:53+09:00</updated>
    <id>http://blog.tkeo.info/blog/2014/12/09/moved</id>
    <content type="html"><![CDATA[<p>hatenablogから引っ越してきた。
octopressお手軽でいい感じ。</p>

<p>zshだと<code>rake new_post</code>のときにglob展開しようとして怒られるので、noglobをつける。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rake new_post['hoge']
</span><span class='line'>zsh: no matches found: new_post[hoge]
</span><span class='line'>$ noglob rake new_post['hoge']
</span><span class='line'>mkdir -p source/_posts
</span><span class='line'>Creating new post: source/_posts/2014-12-09-hoge.markdown</span></code></pre></td></tr></table></div></figure>


<p>面倒なのでaliasを書いてしまった。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>alias rake='noglob rake'</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[日記]]></title>
    <link href="http://blog.tkeo.info/blog/2013/02/05/diary/"/>
    <updated>2013-02-05T01:13:48+09:00</updated>
    <id>http://blog.tkeo.info/blog/2013/02/05/diary</id>
    <content type="html"><![CDATA[<p>railsアプリ開発中にmigrationでエラーが起こって、一部だけ変更が適用された戻すのがめんどくさい中途半端な状態になることがよくあって今日もうぎゃーってなったので、トランザクションで囲んでくれるような仕組みないのかなと思って調べてみると</p>

<p><a href="http://guides.rubyonrails.org/migrations.html">http://guides.rubyonrails.org/migrations.html</a></p>

<blockquote><p>On databases that support transactions with statements that change the schema (such as PostgreSQL or SQLite3), migrations are wrapped in a transaction. If the database does not support this (for example MySQL) then when a migration fails the parts of it that succeeded will not be rolled back. You will have to rollback the changes that were made by hand.</p></blockquote>

<p>なんだってー</p>

<p>postgresはデフォルトで対応しているが、mysqlはサポートされてなくて非対応。知らなかった…。</p>

<p>一応mysqlのドキュメントにもあたってみる。</p>

<p><a href="http://dev.mysql.com/doc/refman/5.6/en/cannot-roll-back.html">http://dev.mysql.com/doc/refman/5.6/en/cannot-roll-back.html</a></p>

<blockquote><p>Some statements cannot be rolled back. In general, these include data definition language (DDL) statements, such as those that create or drop databases, those that create, drop, or alter tables or stored routines.</p></blockquote>

<p>DDLはロールバックできない、と。</p>

<p>開発環境だけDBサーバ変えるとかしたくないし、どうしたらいいかなあ。</p>

<p>という日記。</p>

<h2>追記</h2>

<p><code>change_table</code>で<code>bulk: true</code>オプションを付けてあげればいいらしい。
ひとつのALTERでまとめてカラム追加・削除されるので中途半端な状態は作られない。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails4 で MiniTest + Spork + Guard]]></title>
    <link href="http://blog.tkeo.info/blog/2013/01/17/rails4-minitest-spork-guard/"/>
    <updated>2013-01-17T14:33:15+09:00</updated>
    <id>http://blog.tkeo.info/blog/2013/01/17/rails4-minitest-spork-guard</id>
    <content type="html"><![CDATA[<p>正式版が出る頃には変わっている可能性が高いが、現時点でのメモを残しておく。</p>

<h2>minitest-rails</h2>

<p><a href="https://github.com/blowmage/minitest-rails">https://github.com/blowmage/minitest-rails</a></p>

<p>Gemfile に追加。</p>

<pre><code>gem "minitest-rails"
</code></pre>

<p>必要なファイルを生成。</p>

<pre><code>$ rails generate mini_test:install
</code></pre>

<p>test/minitest_helper.rb が生成される。</p>

<pre><code>ENV["RAILS_ENV"] = "test"
require File.expand_path('../../config/environment', __FILE__)

require "minitest/autorun"
require "minitest/rails"

# Add `gem "minitest/rails/capybara"` to the test group of your Gemfile
# and uncomment the following if you want Capybara feature tests
# require "minitest/rails/capybara"

# Uncomment if you want awesome colorful output
# require "minitest/pride"

class ActiveSupport::TestCase
  # Setup all fixtures in test/fixtures/*.(yml|csv) for all tests in alphabetical order.
  fixtures :all

  # Add more helper methods to be used by all tests here...
end
</code></pre>

<p>各testファイルでこれを読み込むために下の一行が必要。</p>

<pre><code>require 'minitest_helper'
</code></pre>

<p>動作確認。</p>

<pre><code>$ ruby -Itest test/foo/bar_test.rb
</code></pre>

<h2>spork-minitest</h2>

<p><a href="https://github.com/semaperepelitsa/spork-minitest">https://github.com/semaperepelitsa/spork-minitest</a></p>

<p>Gemfile に追加。</p>

<pre><code>gem "spork", "~&gt; 1.0rc"
gem "spork-minitest", "~&gt; 1.0.0.beta1"
</code></pre>

<p>下記コマンドを実行し、minitest_helper に spork 向けの設定を追加する。</p>

<pre><code>$ spork minitest --bootstrap
</code></pre>

<p>test/minitest_helper.rb に追記されるので適宜編集する。</p>

<pre><code>$LOAD_PATH &lt;&lt; "test"
require 'rubygems'
require 'spork'
#uncomment the following line to use spork with the debugger
#require 'spork/ext/ruby-debug'

Spork.prefork do
  # Loading more in this block will cause your tests to run faster. However,
  # if you change any configuration or code from libraries loaded here, you'll
  # need to restart spork for it take effect.

  ENV["RAILS_ENV"] = "test"
  require File.expand_path('../../config/environment', __FILE__)

  require "minitest/autorun"
  require "minitest/rails"
  require 'simplecov'
  require 'simplecov-rcov'

  SimpleCov.formatter = SimpleCov::Formatter::RcovFormatter
  SimpleCov.start 'rails'

  # Add `gem "minitest/rails/capybara"` to the test group of your Gemfile
  # and uncomment the following if you want Capybara feature tests
  # require "minitest/rails/capybara"

  # Uncomment if you want awesome colorful output
  # require "minitest/pride"

  class ActiveSupport::TestCase
    # Setup all fixtures in test/fixtures/*.(yml|csv) for all tests in alphabetical order.
    fixtures :all

    # Add more helper methods to be used by all tests here...
  end
end

Spork.each_run do
  # This code will be run each time you run your specs.

end

# --- Instructions ---
# Sort the contents of this file into a Spork.prefork and a Spork.each_run
# block.
#
# The Spork.prefork block is run only once when the spork server is started.
# You typically want to place most of your (slow) initializer code in here, in
# particular, require'ing any 3rd-party gems that you don't normally modify
# during development.
#
# The Spork.each_run block is run each time you run your specs.  In case you
# need to load files that tend to change during development, require them here.
# With Rails, your application modules are loaded automatically, so sometimes
# this block can remain empty.
#
# Note: You can modify files loaded *from* the Spork.each_run block without
# restarting the spork server.  However, this file itself will not be reloaded,
# so if you change any of the code inside the each_run block, you still need to
# restart the server.  In general, if you have non-trivial code in this file,
# it's advisable to move it into a separate file so you can easily edit it
# without restarting spork.  (For example, with RSpec, you could move
# non-trivial code into a file spec/support/my_helper.rb, making sure that the
# spec/support/* files are require'd from inside the each_run block.)
#
# Any code that is left outside the two blocks will be run during preforking
# *and* during each_run -- that's probably not what you want.
#
# These instructions should self-destruct in 10 seconds.  If they don't, feel
# free to delete them.
</code></pre>

<p>sporkの動作確認をする。</p>

<pre><code>$ spork
</code></pre>

<p>sporkを立ち上げた状態のまま、別窓を開いて testdrb でテスト実行してみる。</p>

<pre><code>$ testdrb test/**/*.rb
</code></pre>

<h2>guard-minitest</h2>

<p><a href="https://github.com/guard/guard-minitest">https://github.com/guard/guard-minitest</a></p>

<p>本家のものを使いたいところではあるが、sporkと組み合わせた時に動かないので一旦他の人が作ったブランチを使わせてもらう。
(ref. <a href="https://github.com/guard/guard-minitest/pull/41">https://github.com/guard/guard-minitest/pull/41</a>)</p>

<p>sporkを使わないのであれば本家のものでもおそらく問題ない。</p>

<p>Gemfile に追加。</p>

<pre><code>gem "guard-minitest", github: "itrcdevs/guard-minitest", branch: "fix_for_spork-minitest"
</code></pre>

<p>設定ファイルを生成する。すでにファイルが存在する場合は内容が追記される。</p>

<pre><code>$ guard init minitest
</code></pre>

<p>生成された Guardfile を編集する。</p>

<pre><code># More info at https://github.com/guard/guard#readme

guard 'minitest' do
  # with Minitest
  watch(%r|^test/(.*)_test\.rb|)
  watch(%r|^lib/(.*)([^/]+)\.rb|)     { |m| "test/#{m[1]}test_#{m[2]}.rb" }
  watch(%r|^test/test_helper\.rb|)    { "test" }

  # Rails
  watch(%r|^app/controllers/(.*)\.rb|) { |m| "test/controllers/#{m[1]}_test.rb" }
  watch(%r|^app/helpers/(.*)\.rb|)     { |m| "test/helpers/#{m[1]}_test.rb" }
  watch(%r|^app/models/(.*)\.rb|)      { |m| "test/models/#{m[1]}_test.rb" }
end
</code></pre>

<p>guard の動作確認。</p>

<pre><code>$ guard
</code></pre>

<p>適当にファイルをtouchしてみるとテストが走るはず。
何も起こらない場合はちゃんと監視対象に入っているか記述を見なおしてみる。</p>

<h2>guard-spork</h2>

<p>Gemfile に追加。</p>

<pre><code>gem "guard-spork"
</code></pre>

<p>Guardfile に設定を追加する。</p>

<pre><code>$ guard init spork
</code></pre>

<p>Guardfile に追加された spork の箇所の編集と、minitest で drb を使うように変更する。</p>

<pre><code>guard 'spork', minitest: true, minitest_env: { 'RAILS_ENV' =&gt; 'test' }, bundler: true do
  watch('config/application.rb')
  watch('config/environment.rb')
  watch('config/environments/test.rb')
  watch(%r{^config/initializers/.+\.rb$})
  watch('Gemfile')
  watch('Gemfile.lock')
  watch('test/minitest_helper.rb') { 'test' }
end

guard 'minitest', drb: true do
  # (省略)
end
</code></pre>

<p>実行。</p>

<pre><code>$ guard
</code></pre>

<p>これだけで spork が自動的に起動する。
先と同じようにファイルを編集したときに動けばOK</p>

<h2>その他</h2>

<ul>
<li>factory_firl_rails を入れると mintiest 用のgeneratorがちゃんと動かない (追記：githubのmasterは修正されてた)</li>
<li>まだプロジェクトの規模が小さいのでsporkの恩恵を感じられない…</li>
<li>spork-rails が必要かと思ってrails4ブランチも含めて試してみたが要らなかった（入れると逆にダメになる）</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby2.0+Rails4で新規プロジェクトを作成したメモ]]></title>
    <link href="http://blog.tkeo.info/blog/2013/01/09/ruby2-rails4-new-project/"/>
    <updated>2013-01-09T13:32:37+09:00</updated>
    <id>http://blog.tkeo.info/blog/2013/01/09/ruby2-rails4-new-project</id>
    <content type="html"><![CDATA[<h2>前準備</h2>

<pre><code>$ brew install openssl
$ brew link openssl
$ brew install readline
$ brew link readline
</code></pre>

<p>プロジェクトのディレクトリ作る。</p>

<pre><code>$ mkdir hoge &amp;&amp; cd hoge
</code></pre>

<h2>ruby</h2>

<p>ruby 2.0.0-devを入れる。</p>

<pre><code>$ CONFIGURE_OPTS="--with-openssl-dir=`brew --prefix openssl` --with-readline-dir=`brew --prefix readline`" rbenv install 2.0.0-dev
$ rbenv local 2.0.0-dev
</code></pre>

<p>bundlerのバージョンが1.2だと怒られるので1.3を入れる。</p>

<pre><code>$ gem install bundler -v 1.3.0.pre.4
</code></pre>

<h2>rails</h2>

<p>一旦Gemfileにrailsだけ書いてbundle installする。 まだrails 4.0のgemがないのでgithubから取ってくるように指定。</p>

<pre><code>$ cat Gemfile
source :rubygems
gem 'rails', github: 'rails/rails'
</code></pre>

<p>bundle installを実行し、まずrails本体だけ入れる。</p>

<pre><code>$ bundle install
</code></pre>

<p>rails newしていろいろファイルを生成。Gemfileを上書きするか聞かれるので Y で上書き。</p>

<pre><code>$ bundle exec rails new . -d mysql -T --skip-bundle --edge
</code></pre>

<p>再度bundle install</p>

<pre><code>$ bundle install
</code></pre>

<p>これで完了。あとはいつもどおりDBを作って…</p>

<pre><code>$ bundle exec rake db:create
</code></pre>

<p>起動する。</p>

<pre><code> $ bundle exec rails s
=&gt; Booting WEBrick
=&gt; Rails 4.0.0.beta application starting in development on http://0.0.0.0:3000
=&gt; Call with -d to detach
=&gt; Ctrl-C to shutdown server
        SECURITY WARNING: No secret option provided to Rack::Session::Cookie.
        This poses a security threat. It is strongly recommended that you
        provide a secret to prevent exploits that may be possible from crafted
        cookies. This will not be supported in future versions of Rack, and
        future versions will even invalidate your existing user cookies.

        Called from: xxx/ruby/2.0.0/bundler/gems/rails-e63e280bed3a/actionpack/lib/action_dispatch/middleware/session/abstract_store.rb:24:in `initialize'.
[2013-01-07 19:35:35] INFO  WEBrick 1.3.1
[2013-01-07 19:35:35] INFO  ruby 2.0.0 (2013-01-07) [x86_64-darwin11.4.2]
[2013-01-07 19:35:35] INFO  WEBrick::HTTPServer#start: pid=76843 port=3000
</code></pre>

<p>なにやらWARNING出てるけど、とりあえずwelcome画面が出た。</p>

<h2>参考</h2>

<ul>
<li><a href="http://blog.katsuma.tv/2013/01/ruby2.0_rails4.html">Ruby2.0 + Rails4 なアプリを作成する - blog.katsuma.tv</a></li>
<li><a href="http://d.hatena.ne.jp/deeeki/20121124/rails4_1st_impression">Rails4 beta さわってみたメモ #railshackathon - 130単位</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ログイン直後にtmuxを起動する]]></title>
    <link href="http://blog.tkeo.info/blog/2012/11/15/login-tmux/"/>
    <updated>2012-11-15T14:15:22+09:00</updated>
    <id>http://blog.tkeo.info/blog/2012/11/15/login-tmux</id>
    <content type="html"><![CDATA[<p>SHLVLっていう環境変数があることを知ったので、.zshrcに以下を追記してログイン直後にtmuxを起動するようにしてみた。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if [ $SHLVL = 1 ]; then
</span><span class='line'>  tmux attach || tmux new
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[macでsshfsを使う]]></title>
    <link href="http://blog.tkeo.info/blog/2012/05/09/mac-sshfs/"/>
    <updated>2012-05-09T02:12:41+09:00</updated>
    <id>http://blog.tkeo.info/blog/2012/05/09/mac-sshfs</id>
    <content type="html"><![CDATA[<p>なんかぐぐるとMacFUSEを入れる方法ばっかり出てくるけど、brewで入れるのであれば不要。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew install sshfs
</span><span class='line'>(略)
</span><span class='line'>==&gt; Caveats
</span><span class='line'>Make sure to follow the directions given by `brew info fuse4x-kext`
</span><span class='line'>before trying to use a FUSE-based filesystem.
</span><span class='line'>==&gt; Summary
</span><span class='line'>/usr/local/Cellar/sshfs/2.3.0: 7 files, 120K, built in 12 seconds</span></code></pre></td></tr></table></div></figure>


<p>installすると上のように言われるので指示に従う。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew info fuse4x-kext
</span><span class='line'>fuse4x-kext 0.8.14
</span><span class='line'>http://fuse4x.org/
</span><span class='line'>/usr/local/Cellar/fuse4x-kext/0.8.14 (7 files, 312K)
</span><span class='line'>
</span><span class='line'>In order for FUSE-based filesystems to work, the fuse4x kernel extension
</span><span class='line'>must be installed by the root user:
</span><span class='line'>
</span><span class='line'>  sudo cp -rfX /usr/local/Cellar/fuse4x-kext/0.8.14/Library/Extensions/fuse4x.kext /System/Library/Extensions
</span><span class='line'>  sudo chmod +s /System/Library/Extensions/fuse4x.kext/Support/load_fuse4x
</span><span class='line'>
</span><span class='line'>If upgrading from a previous version of Fuse4x, the old kernel extension
</span><span class='line'>will need to be unloaded before performing the steps listed above. First,
</span><span class='line'>check that no FUSE-based filesystems are running:
</span><span class='line'>
</span><span class='line'>  mount | grep fuse4x
</span><span class='line'>
</span><span class='line'>Unmount all FUSE filesystems and then unload the kernel extension:
</span><span class='line'>
</span><span class='line'>  sudo kextunload -b org.fuse4x.kext.fuse4x
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>http://github.com/mxcl/homebrew/commits/master/Library/Formula/fuse4x-kext.rb</span></code></pre></td></tr></table></div></figure>


<p>上のsudoコマンド2つを叩くだけで使えるようになる(下の方はアップグレードのときに実行するらしい)</p>
]]></content>
  </entry>
  
</feed>
